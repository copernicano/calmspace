# Sessione di Sviluppo - 5 Dicembre 2025

## Modifiche Effettuate

### 1. Chatbot AI - Configurazione Utente
**File modificati:**
- `src/contexts/EnhancedSettingsContext.js` - Aggiunto oggetto `aiAssistant` nelle settings
- `src/components/core/EnhancedSettings.js` - UI per configurare API key e modello
- `src/utils/apiService.js` - Gestione dinamica API key e system prompt contestuale

**FunzionalitÃ  aggiunte:**
- Toggle per abilitare/disabilitare assistente
- PossibilitÃ  di usare chiave API personale OpenRouter
- Selezione modello da dropdown (gemma, llama, mistral, qwen, custom)
- System prompt dinamico con contesto app (emozione, intensitÃ , pagina corrente)

### 2. Chatbot AI - Suggerimenti Contestuali
**File modificati:**
- `src/components/chat/ChatBot.js` - Completa riscrittura
- `src/components/chat/ChatButton.js` - Passaggio props contesto
- `src/components/core/App.js` - Integrazione useLocation

**FunzionalitÃ  aggiunte:**
- Suggerimenti dinamici basati su emozione E intensitÃ  (18 combinazioni)
- Messaggio di benvenuto contestuale
- Indicatore emozione nell'header del chatbot
- Lettura emozione/intensitÃ  da localStorage

### 3. Salvataggio IntensitÃ 
**File modificati:**
- `src/components/emotion-support/EnhancedEmotionSelector.js`

**Problema risolto:**
L'intensitÃ  non veniva salvata in localStorage, quindi il chatbot non poteva leggerla.
Ora `handleIntensitySelect` e `handleSkipIntensity` salvano entrambi l'intensitÃ  insieme all'emozione.

### 4. UI Chatbot
**File modificati:**
- `src/styles/chatbot.css`

**Modifiche:**
- Container aumentato: 400px x 600px
- Sfondi solidi (non trasparenti)
- Suggerimenti limitati a max 100px di altezza
- Messages container con min-height 200px

---

## Problemi Incontrati e Soluzioni

### Problema 1: Pulsante Assistente Scomparso
**Causa:** `settings.aiAssistant?.enabled === false` restituiva false anche quando undefined
**Soluzione:** Usare nullish coalescing: `settings.aiAssistant?.enabled ?? true`

### Problema 2: Modello Non Disponibile
**Causa:** Il modello `meta-llama/llama-4-maverick:free` non esiste piÃ¹ su OpenRouter
**Soluzione:** Reso parametrico con dropdown nelle impostazioni

### Problema 3: Chatbot Trasparente
**Causa:** CSS usava `var(--background-color)` non definita
**Soluzione:** Usare colori espliciti (#ffffff, #f8f9fa, ecc.)

### Problema 4: Suggerimenti Non Contestuali
**Causa:** `EnhancedEmotionSelector` ha stato interno, non passa emozione a App.js
**Soluzione:** ChatBot legge direttamente da localStorage (`lastEmotion`)

### Problema 5: IntensitÃ  Non Salvata
**Causa:** Solo l'emozione veniva salvata, non l'intensitÃ 
**Soluzione:** Modificato `handleIntensitySelect` per salvare `{ ...emotion, intensity }`

---

## Note per Sviluppi Futuri

### Aggiungere Nuove Animazioni

Per evitare lunghe sessioni di debug, seguire questa checklist:

#### 1. Struttura File
```
src/components/calm-space/
â”œâ”€â”€ [NomeAnimazione]Animation.js   <- Nuovo componente
```

#### 2. Template Base Animazione
```javascript
import React, { useEffect, useRef } from 'react';
import gsap from 'gsap';

const NuovaAnimazione = ({ colorPalette = 'default' }) => {
  const containerRef = useRef(null);

  useEffect(() => {
    const container = containerRef.current;
    if (!container) return;

    // Pulisci container
    container.innerHTML = '';

    // Crea elementi
    const element = document.createElement('div');
    element.className = 'mio-elemento';
    container.appendChild(element);

    // Anima con GSAP
    gsap.to(element, {
      x: 100,
      duration: 2,
      repeat: -1,
      yoyo: true,
      ease: 'sine.inOut'
    });

    // CLEANUP CRITICO - previene memory leak
    return () => {
      gsap.killTweensOf(element);
      container.innerHTML = '';
    };
  }, [colorPalette]);

  return (
    <div
      ref={containerRef}
      className="animation-container"
      style={{
        position: 'absolute',
        inset: 0,
        overflow: 'hidden'
      }}
    />
  );
};

export default NuovaAnimazione;
```

#### 3. Registrare in EnhancedSimplePatterns.js
Aggiungere alla lista `patterns`:
```javascript
{
  id: 'nuova-animazione',
  name: 'Nome Animazione',
  icon: 'ğŸ¨',
  description: 'Descrizione breve',
  component: NuovaAnimazione,
}
```

#### 4. Stile Artistico (NON Matematico)
- **NO:** `Math.sin()`, onde regolari, pattern simmetrici
- **SI:** Curve Bezier manuali, movimenti organici, parallax

#### 5. Performance
- Usare `transform` (x, y, scale, rotate) per GPU
- Evitare animare width/height/top/left
- Max 50-100 elementi animati contemporaneamente
- Testare su mobile

---

## Architettura Stato Emozione

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    localStorage                          â”‚
â”‚                   'lastEmotion'                          â”‚
â”‚        { name: 'triste', intensity: 3, ... }            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â–²                              â”‚
          â”‚ saveToStorage()              â”‚ getFromStorage()
          â”‚                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EnhancedEmotion     â”‚         â”‚     ChatBot.js      â”‚
â”‚ Selector.js         â”‚         â”‚                     â”‚
â”‚                     â”‚         â”‚ Legge emozione +    â”‚
â”‚ Salva quando utente â”‚         â”‚ intensitÃ  per       â”‚
â”‚ seleziona intensitÃ  â”‚         â”‚ suggerimenti        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**NOTA:** App.js passa `emotion` e `intensity` come props a ChatButton,
ma questi sono spesso null perchÃ© EnhancedEmotionSelector gestisce tutto internamente.
Il ChatBot ora legge SEMPRE da localStorage per avere dati aggiornati.

---

## File Chiave da Conoscere

| File | Scopo |
|------|-------|
| `EnhancedSettingsContext.js` | Tutte le impostazioni app |
| `apiService.js` | Chiamate OpenRouter + system prompt |
| `ChatBot.js` | Logica chatbot + suggerimenti |
| `EnhancedEmotionSelector.js` | Flusso selezione emozione |
| `EnhancedSimplePatterns.js` | Registro animazioni disponibili |
| `chatbot.css` | Stili chatbot |

---

## TODO Futuri (non implementati)

- [ ] Sincronizzare stato emozione tra App.js e EnhancedEmotionSelector
- [ ] Aggiungere history conversazione chatbot
- [ ] Permettere ridimensionamento finestra chatbot
- [ ] Aggiungere piÃ¹ animazioni (aurora, foresta, pioggia)
